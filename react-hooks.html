<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css" />
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://raw.githubusercontent.com/yujiachen-y/yjc567.github.io/main/pictures/icon.JPG">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>React Hooks&nbsp;|&nbsp;Jiachen’s Blog</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="React Hooks">
  
  
    <meta property="og:image" content="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;*️⃣&lt;/text&gt;&lt;/svg&gt;">
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://raw.githubusercontent.com/yujiachen-y/yjc567.github.io/main/pictures/icon.JPG"></span>&nbsp;
      
      <span>主页</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="tag/%E6%9D%82%E6%96%87.html">
    <div class="Navbar__Btn">
      <span>杂文</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="tag/%E6%8A%80%E6%9C%AF.html">
    <div class="Navbar__Btn">
      <span>技术</span>
    </div>
  </a>
  <span class="Navbar__Delim">&centerdot;</span>
  <a href="tag/%E9%98%85%E8%AF%BB.html">
    <div class="Navbar__Btn">
      <span>阅读</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="other.html">
        <div class="Navbar__Btn">
          
          <span>其他</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
          <span>关于</span>
        </div>
      </a>
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
      <div class="Header__Icon">
        <span><img class="inline-img-icon" src="data:image/svg+xml,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22&gt;&lt;text text-anchor=%22middle%22 dominant-baseline=%22middle%22 x=%2250%22 y=%2255%22 font-size=%2280%22&gt;*️⃣&lt;/text&gt;&lt;/svg&gt;"></span>
      </div>
    
    <h1 class="Header__Title">React Hooks</h1>
    
      <div class="DateTagBar">
        
          <span class="DateTagBar__Item DateTagBar__Date">Posted on 2020年6月27日周六</span>
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--gray">
            <a href="tag/技术.html">技术</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/63b459e7eafa4e9ba74c295402c20041" class="PageRoot"><div id="https://www.notion.so/3a8b974806d44582ab185d9863333752" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">所有的理解都基于React V16.11</strong></span><span class="SemanticString"> </span></span></p></div><div id="https://www.notion.so/40ec7047f91045c4968be8bd1de587b1" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">💡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">给一点take away 吧，说一说对我帮助最大的两个心得：
</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">initialState</code></span><span class="SemanticString"> 的改变不会影响hooks 返回结果的改变，因为mount 前后的hooks 函数根本就是两套。
多个 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useEffect</code></span><span class="SemanticString"> 分别set 一下state，dispatch 一下action 啥的其实不一定会引起多次渲染，因为hook 会用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">renderPhaseUpdates</code></span><span class="SemanticString"> 来判断race condition，如果优化够好的话多个 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useEffect</code></span><span class="SemanticString"> 和单个的效果应该差不多。</span></span></p></div><div id="https://www.notion.so/51dc6b08b23d44f4abb4837257f9dc83" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">两篇很有用的文章</span></span></p></div><div id="https://www.notion.so/972a489b0d2c4e0d9b734848919c5f4e" class="Bookmark"><a href="https://me.ursb.me/archives/useState.html#directory0792415527436750625"><h5 class="Bookmark__Title">React Hooks 源码解析（3）：useState</h5><p class="Bookmark__Desc">在写本文之前，事先阅读了网上了一些文章，关于 Hooks 的源码解析要么过于浅显、要么就不细致，所以本文着重讲解源码，由浅入深，争取一行代码也不放过。那本系列讲解第一个 Hooks 便是 useState，我们将从 useState 的用法开始，再阐述规则、讲解原理，再简单实现，最后源码解析。另外，在本篇开头，再补充一个 Hooks 的概述，前两篇·限于篇幅问题一直没有写一块。 注：距离上篇文章已经过去了两个月，这两个月业务繁忙所以没有什么时间更新该系列的文章，但 react 这两个月却从 16.9 更新到了 16.11，review 了一下这几次的更新都未涉及到 hooks，所以我也直接把源码笔记这块更新到了 16.11。 Hook 是 React 16.8 的新增特性，它可以让你在不编写 class 的情况下使用 state 以及其他的 React 特性。其本质上就是一类特殊的函数，它们约定以 use 开头，可以为 Function Component 注入一些功能，赋予 Function Component 一些 Class Component 所具备的能力。 例如，原本我们说 Function Component 无法保存状态，所以我们经常说 Stateless Function Component，但是现在我们借助 useState 这个</p><p class="Bookmark__Link">https://me.ursb.me/archives/useState.html#directory0792415527436750625</p></a></div><div id="https://www.notion.so/fbb2c4f7948b4390a94aa95f92aad2cf" class="Bookmark"><a href="https://me.ursb.me/archives/useEffect.html#directory087217065341216589"><p class="Bookmark__Link">https://me.ursb.me/archives/useEffect.html#directory087217065341216589</p></a></div><div id="https://www.notion.so/0b0a44ade6714f0590d117a0b423d632" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><details id="https://www.notion.so/a98cc073dd2a4e43b45c943d23f5f1d7" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">Hooks 有什么好处？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/dff55b749d034ecc9107261a455a1fd7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">赋予了函数式组件状态，用类组件来管理状态可能有如下缺点：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/90a532f661214243b65d5b3eb3437ab1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">逻辑分散，处理同一个东西的逻辑可能会被分散在 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">componentDidMount</code></span><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">componentDidUpdate</code></span><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">componentDidUnmount</code></span><span class="SemanticString"> 里面。
特别是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useEffect</code></span><span class="SemanticString"> 把一些副作用操作都统一了。</span></span></li><li id="https://www.notion.so/c1d320ea292e41c0985bf9dfb1744477" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">范式复杂，class 可能把一些原可以简单的组件弄复杂了。</span></span></li></ul></div></details><details id="https://www.notion.so/7218296f3a93456585690b8756580e22" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">涉及到的数据结构有哪些？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/7231d0039f8e463c8b416a16d6b47338" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">💡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">简单来说，一个fiber 对应一个hooks 链表，一个hook 对应state 和update queue。</span></span></p></div><details id="https://www.notion.so/f1a7547577df466cb662325403d8a0cd" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">这些数据结构的具体定义和交互是怎么样的？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/1505524c263c4789adf63780ca47acb0" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F91445c9d-3adb-49af-8b73-8b4e6c04cc8a%2FUntitled.png?width=672&amp;table=block&amp;id=1505524c-263c-4789-adf6-3780ca47acb0"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F91445c9d-3adb-49af-8b73-8b4e6c04cc8a%2FUntitled.png?width=672&amp;table=block&amp;id=1505524c-263c-4789-adf6-3780ca47acb0" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><h2 id="https://www.notion.so/5a6ced4f2ea84aeb84a949d99f52cac4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/5a6ced4f2ea84aeb84a949d99f52cac4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Hook</span></span></h2><pre id="https://www.notion.so/b639e8f565de4ee2a09d3ed05c98480d" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">hook</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  memorizedState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  
  baseState<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span>
  baseUpdate<span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  queue<span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  next<span class="token operator">:</span> Hook <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></span></span></span></code></pre><ul class="BulletedListWrapper"><li id="https://www.notion.so/85c275440eac484cbc0a82fdc7643884" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">hooks 通过链表连接在一起。</span></span></li><li id="https://www.notion.so/2911025383f7418db59b79bf09e6d3ac" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">有 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">memorizedState</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">baseState</code></span><span class="SemanticString"> 的区别，两者的不同之处目前还不得而知，不过每次调用hook 返回的都是</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">memorizedState</code></span><span class="SemanticString"> 。</span></span></li></ul><div id="https://www.notion.so/5eb80f6be444425e8c9650f311a224f9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><details id="https://www.notion.so/f7d59416715346c482c3183f40360bba" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">memorizedState</code></span><span class="SemanticString"> 和</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">baseState</code></span><span class="SemanticString"> 有可能不同吗？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/3a02ab269b304aec96db4c9acf21c440" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">有可能。</span></span></p></div><div id="https://www.notion.so/e2f408ebb9cb4ee59e560964d385c4f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">memorizedState</code></span><span class="SemanticString"> 代表的是上一次hook 返回给组件的 state，而这个 state 有可能是“非法状态”。</span></span></p><div class="Text__Children"><div id="https://www.notion.so/5941aa8fa3ad41ed81f6cdbe1b77223a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这个“非法状态”会在 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">updateReducer</code></span><span class="SemanticString">里面诞生，当遍历 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queue</code></span><span class="SemanticString"> 中的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">update</code></span><span class="SemanticString"> ，计算新 state 的时候，有可能发生 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">update.expirationTime &lt; renderExpirationTime</code></span><span class="SemanticString"> 的情况。此时hook 会选择不去执行 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">update.action</code></span><span class="SemanticString"> ，非法状态就就诞生了。</span></span></p></div></div></div><div id="https://www.notion.so/b524bd1dd7a54458b95aac777c835d29" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当然，为了之后修正当前的这个非法状态，hook 就把 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">baseState</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">baseUpdate</code></span><span class="SemanticString"> 置成了第一次skip 时的 state 和 update，某个时刻重新从 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">baseState</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">baseUpdate</code></span><span class="SemanticString"> 计算真正合法的 state。</span></span></p></div><div id="https://www.notion.so/2f3a9ca22b4e4d5c99e09cbd0f7bcd46" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">这是为了在资源不足的情况下优先完成高优先级任务。</strong></span></span></p></div><div id="https://www.notion.so/38542b0120bf4f249117759359feda71" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">不管怎么说，在资源和时间充足的情况下，从 </strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">baseState</strong></code></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"> 和 </strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">baseUpdate</strong></code></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"> 重新追赶后就能得到正确的state。</strong></span></span></p></div></div></details><details id="https://www.notion.so/3d8fa074386448349d8f364e9c12630f" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">为什么hook 的</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queue</code></span><span class="SemanticString"> 有时是循环链表，有时不是？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/1922947dea1b4dde86dbdb6d7e41076a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">参照后面的更新状态callback 具体实现的section。</span></span></p></div></div></details><h2 id="https://www.notion.so/792278a4a9d04eb6ab84c14b61b36c20" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/792278a4a9d04eb6ab84c14b61b36c20"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Update</span></span></h2><pre id="https://www.notion.so/2b2d1260e5ee4c0f8f7397cd3c451f4f" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">type</span> <span class="token class-name">Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">></span></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  expirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
  suspenseConfig<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span>
  action<span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">,</span>
  eagerReducer<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  eagerState<span class="token operator">:</span> <span class="token constant">S</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  next<span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  priority<span class="token operator">?</span><span class="token operator">:</span> ReactPriorityLevel<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></span></span></span></code></pre><ul class="BulletedListWrapper"><li id="https://www.notion.so/fa0ed0bc86db4fa9acc62879d2360a91" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">updates 也是通过链表连接在一起的。</span></span></li><li id="https://www.notion.so/d281408273c74909b689d70de882ec87" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">update 有 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">expirationTime</code></span><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">suspenseConfig</code></span><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">priority</code></span><span class="SemanticString"> 各种配置参数。</span></span></li></ul><div id="https://www.notion.so/3505f6b493ce4c9892809c1747ecf2c5" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><details id="https://www.notion.so/9dde752dff2f43e09ad18afe853567b0" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">expirationTime</code></span><span class="SemanticString"> 的具体作用？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/207db993a7f7450799c36898cc79c84a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不知道。</span></span></p></div></div></details><details id="https://www.notion.so/4cf81d9acb374d4291d762520df9d266" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">啥是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">suspenseConfig</code></span><span class="SemanticString"> ？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/e78a82300d3148afbcc69d1819d417f3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不知道。</span></span></p></div></div></details><details id="https://www.notion.so/44a259931fa44a86aa2c84aedc2c61b6" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">为啥要有 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">eagerReducer</code></span><span class="SemanticString"> ，和传入 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">updateReducer()</code></span><span class="SemanticString"> 中的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">reducer</code></span><span class="SemanticString"> 参数互相区分？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/85370fa9ab0e4b4a899fa4df54433e45" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不知道。</span></span></p></div></div></details><h2 id="https://www.notion.so/33ac195175854243ac919b0933a0b0a7" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/33ac195175854243ac919b0933a0b0a7"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">UpdateQueue</span></span></h2><pre id="https://www.notion.so/fbfe62b0b3c94d689e7e1df9a28f00c6" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">type</span> <span class="token class-name">UpdateQueue<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">></span></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  last<span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  dispatch<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token constant">A</span> <span class="token operator">=></span> mixed<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  lastRenderedReducer<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">S</span><span class="token punctuation">,</span> <span class="token constant">A</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">S</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  lastRenderedState<span class="token operator">:</span> <span class="token constant">S</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></span></span></span></code></pre><ul class="BulletedListWrapper"><li id="https://www.notion.so/03679191ac1b40f6b8d72ac9ccf0cbb6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dispatch</code></span><span class="SemanticString"> 被封装过，供外界调用使用。所有的hook 都对同一个公共的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">dispatch</code></span><span class="SemanticString"> 进行了封装。</span></span></li></ul><div id="https://www.notion.so/66c11255ffd64682847ee95a46507690" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><details id="https://www.notion.so/7a16aac9e3ba46559480b050a0c92b57" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queue</code></span><span class="SemanticString"> 里面为什么还要特意封装一下 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">lastRenderedReducer</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">lastRenderedState</code></span><span class="SemanticString"> ？用hook 自带的一些信息不好吗？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/851d5a4a35884fae964e4867a5e35e05" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不知道。</span></span></p></div></div></details><h2 id="https://www.notion.so/87bd715e48d44e889bebdceaea437f09" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/87bd715e48d44e889bebdceaea437f09"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">HooksDispatcherOnMount &amp; HooksDispatcherOnUpdate</span></span></h2><pre id="https://www.notion.so/5fc6984288024241b14b3393709c1a2e" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">const</span> HooksDispatcherOnMount<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  readContext<span class="token punctuation">,</span>

  useCallback<span class="token operator">:</span> mountCallback<span class="token punctuation">,</span>
  useContext<span class="token operator">:</span> readContext<span class="token punctuation">,</span>
  useEffect<span class="token operator">:</span> mountEffect<span class="token punctuation">,</span>
  useImperativeHandle<span class="token operator">:</span> mountImperativeHandle<span class="token punctuation">,</span>
  useLayoutEffect<span class="token operator">:</span> mountLayoutEffect<span class="token punctuation">,</span>
  useMemo<span class="token operator">:</span> mountMemo<span class="token punctuation">,</span>
  useReducer<span class="token operator">:</span> mountReducer<span class="token punctuation">,</span>
  useRef<span class="token operator">:</span> mountRef<span class="token punctuation">,</span>
  useState<span class="token operator">:</span> mountState<span class="token punctuation">,</span>
  useDebugValue<span class="token operator">:</span> mountDebugValue<span class="token punctuation">,</span>
  useResponder<span class="token operator">:</span> createResponderListener<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> HooksDispatcherOnUpdate<span class="token operator">:</span> Dispatcher <span class="token operator">=</span> <span class="token punctuation">{</span>
  readContext<span class="token punctuation">,</span>

  useCallback<span class="token operator">:</span> updateCallback<span class="token punctuation">,</span>
  useContext<span class="token operator">:</span> readContext<span class="token punctuation">,</span>
  useEffect<span class="token operator">:</span> updateEffect<span class="token punctuation">,</span>
  useImperativeHandle<span class="token operator">:</span> updateImperativeHandle<span class="token punctuation">,</span>
  useLayoutEffect<span class="token operator">:</span> updateLayoutEffect<span class="token punctuation">,</span>
  useMemo<span class="token operator">:</span> updateMemo<span class="token punctuation">,</span>
  useReducer<span class="token operator">:</span> updateReducer<span class="token punctuation">,</span>
  useRef<span class="token operator">:</span> updateRef<span class="token punctuation">,</span>
  useState<span class="token operator">:</span> updateState<span class="token punctuation">,</span>
  useDebugValue<span class="token operator">:</span> updateDebugValue<span class="token punctuation">,</span>
  useResponder<span class="token operator">:</span> createResponderListener<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/15d0ef30da434084b62e7e8096456c0c" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">第一次mount 组件时用mount 系列的hooks 来执行相关的准备、创建操作；之后update 组件用的是update 系列的hooks ，根据之前的状态和操作来返回新的状态。</span></span></p></div><div id="https://www.notion.so/5e5d0db5b64840bdb545f4f7062ab7d6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"> </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">renderWithHooks()</code></span><span class="SemanticString"> 里面有一句：</span></span></p></div><pre id="https://www.notion.so/9eaa19bd60b8416eacdf7907904f65da" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span>nextCurrentHook <span class="token operator">=</span> current <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> current<span class="token punctuation">.</span>memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

ReactCurrentDispatcher<span class="token punctuation">.</span>current <span class="token operator">=</span> 
  nextCurrentHook <span class="token operator">===</span> <span class="token keyword">null</span>
    <span class="token operator">?</span> HooksDispatcherOnMount
    <span class="token operator">:</span> HooksDispatcherOnUpdate<span class="token punctuation">;</span></span></span></span></code></pre><div id="https://www.notion.so/3e126b2a0b374589bf0ebb5fc3df26c7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">其中 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">current</code></span><span class="SemanticString"> 是传入 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">renderWithHooks()</code></span><span class="SemanticString"> 的第一个参数，是一个fiber，若 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">current === null</code></span><span class="SemanticString"> 则目前没有fiber，是首次加载。</span></span></p></div></div></details></div></details><details id="https://www.notion.so/72c94efd0b5e47e189a37597d8709f67" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">首次加载时，hooks 相关的代码都做了什么？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/f9b90bfe0835460a99cc845cac977608" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">💡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">首次加载时调用的是mount 系列hooks，根据hooks 代码的调用创建对应的hooks，并为这些被创建的hooks 分别创建queue，为被创建的queue bind dispatch 函数。</span></span></p></div><div id="https://www.notion.so/ef34d565d10d46ada54c14b641b1f433" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><details id="https://www.notion.so/96a226b9d4e743aa8602a5f48b68a250" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">具体创建hook 的代码是什么逻辑？</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/d825b65b5e84452ea2eef13d1ccbbb08" class="Code Code--NoWrap"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">function</span> <span class="token function">mountWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hook<span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
    memoizedState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    baseState<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    queue<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    baseUpdate<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    firstWorkInProgressHook <span class="token operator">=</span> workInProgressHook <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> hook<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/3757194e2e7540469aa43dc5c79593f6" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">创建一个hook，并将其设置为全局变量 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">workInProgressHook</code></span><span class="SemanticString"> ，同时维护一个hooks 链表，每次都把新创建的hook 放在这个链表的最后。</span></span></p></div></div></details></div></details><details id="https://www.notion.so/b69ab8d633414fd5a2416709fba8c404" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useState</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useReducer</code></span><span class="SemanticString"> 系列的hooks 可以返回一个更改hooks 状态的callback，这里的状态更新是咋实现的，有没有race condition？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/e9d8baace94944cb92abe3cb5fdef0f0" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useState</code></span><span class="SemanticString"> 其实就是特殊情况下的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useReducer</code></span><span class="SemanticString"> ，两者返回的callback 其实就是首次加载中bind 到 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">hook.queue.dispatch</code></span><span class="SemanticString"> 上的dispatch 函数。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/73b081a70d43488d973a2698c57a36a4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">状态更新就是把传入的action 给添加到queue 的最后，并发出一个请求re-render 的事件。</span></span></li><li id="https://www.notion.so/026f6c783c0e40f4bb169fff278ca0ae" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">当然可能存在race condition，这个时候就创建一个key 为queue 的map，缓存一下在re-render 期间发起的action，如果race condition 被引发多次，就把actions 串成一个链表。</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/9cedcf63ad4f45e28ead01f8efa23ba5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">除此之外，根据</span><span class="SemanticString"><a class="SemanticString__Fragment SemanticString__Fragment--Link" href="https://github.com/facebook/react/blob/30b47103d4354d9187dc0f1fb804855a5208ca9f/packages/react-reconciler/src/ReactUpdateQueue.new.js">这个文件</a></span><span class="SemanticString">中的说明，fiber 级别还会有对race condition 的处理，当进行re-render 时，update 链表会分别在current pointer 和work-in-progress pointer 里面被维护，这两个pointer 我理解被存在了不同的fiber 里面。每当有一个新update 事件被添加时，这个update 会被同时添加进这两个pointer or fiber 里，以防止在某些race condition 下被添加的新update 事件丢失。</span></span></li></ul></li></ul><div id="https://www.notion.so/728c8807be6d4809a99ce2ae6aa7a3a3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><details id="https://www.notion.so/5faaa3cb08054103b9ea545c4d17779c" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">把action 添加到queue 的操作是咋样的，这个queue 是单链表对吗？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/dd2e0267c34c40c9959380aa760b87f7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不是单链表，当 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queue.last === null</code></span><span class="SemanticString"> 的时候，被创建出的是一个循环链表。</span></span></p></div><div id="https://www.notion.so/446e4bd31378424088fa9778d8266bed" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">至于为什么是一个循环链表，是因为 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">queue.last === null</code></span><span class="SemanticString"> 这个条件只会在mount 的时候发生，mount or commit 之后的re-render 是要从第一个update 开始的，考虑到：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/3014461249504551b6be21d9a0a1a39d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">循环链表的 </strong></span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">last.next</strong></code></span><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold"> 就是链表的头节点。</strong></span></span></li><li id="https://www.notion.so/b8dd05ddb0f047a0a72582e226b47045" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">除了第一次re-render 后，之后的更新都是从最后一次update 之后的 update 开始更新了，那么寻求的就是update.next。</span></span></li></ul><div id="https://www.notion.so/85468a37820646a58b7288ca39434af7" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">我觉得使用循环链表可以达到以下目的：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/ffdf84063e994b69b7250431e133b481" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">少存一个头节点，只有mount or commit 前才需要头节点，这个时候从 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">last.next</code></span><span class="SemanticString"> 取就好了，其他情况也不需要头节点，此时queue 就不是循环链表了。</span></span></li><li id="https://www.notion.so/b3de45146afe405393fdb2cab59a8adf" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">范式的统一。</span></span></li></ul></div></details></div></details><details id="https://www.notion.so/8ca9500dcdf04d0183b24ee8765e9d34" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">react render 的时候是怎么知道此时是mount 还是update？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/0d1895987c654dd59cfc704f0aa9f11e" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">根据当前fiber 是否为null 来判断。</span></span></p></div></div></details><details id="https://www.notion.so/b7dd0ff335f6434bba4b1b45438f46ca" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">在首次加载后，再次调用hooks 发生了什么？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/4d950db6f08a4af89276f1cc2b09979a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">首次加载之后的hooks 就是update 系列的hooks 了，再拿 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useState</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useReducer</code></span><span class="SemanticString"> 来看， </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useState</code></span><span class="SemanticString"> 会直接调用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">updateReducer</code></span><span class="SemanticString"> ，而首次加载后的 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useReducer</code></span><span class="SemanticString"> 就是 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">updateReducer</code></span><span class="SemanticString"> 。</span></span></p></div><div id="https://www.notion.so/1d475340d3974df3ba0f23c4360b9677" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">updateReducer</code></span><span class="SemanticString"> 被调用时，其会判断当前是否处于re-render 阶段，如果是，按我们上面说的一样，去找key 为queue 的map，取出update 事件链表，计算出新的state。</span></span></p></div><div id="https://www.notion.so/1d85b78aeba94185b07a9a85e3d26a4f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">如果不是re-render 阶段，那么就遍历queue 里面的update ，计算出新的state。</span></span></p><div class="Text__Children"><div id="https://www.notion.so/5850d122e75a4a5bb8929f1d5d46d2c1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不过这里要注意一下特殊情况，会有资源不足而跳过一些update 的情况，参照上文</span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><code class="SemanticString__Fragment SemanticString__Fragment--Code">memorizedState</code></em></span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"> 和</em></span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"><code class="SemanticString__Fragment SemanticString__Fragment--Code">baseState</code></em></span><span class="SemanticString"><em class="SemanticString__Fragment SemanticString__Fragment--Italic"> 有可能不同吗？ </em></span><span class="SemanticString">这个问题。</span></span></p></div><div id="https://www.notion.so/beb26b4ff76447a8a9afd5904ba2c786" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></div></div><details id="https://www.notion.so/41d1c565a73e4d1b92dbbc3699732dbd" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">调用hook 后，具体被操作的hook 是怎么被拿到的？</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/e0b19c431b16494eb2a65729e8c1ad6f" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">function</span> <span class="token function">updateWorkInProgressHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Hook <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextWorkInProgressHook <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// There's already a work-in-progress. Reuse it.</span>
    workInProgressHook <span class="token operator">=</span> nextWorkInProgressHook<span class="token punctuation">;</span>
    nextWorkInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>

    currentHook <span class="token operator">=</span> nextCurrentHook<span class="token punctuation">;</span>
    nextCurrentHook <span class="token operator">=</span> currentHook <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> currentHook<span class="token punctuation">.</span>next <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// Clone from the current hook.</span>
    currentHook <span class="token operator">=</span> nextCurrentHook<span class="token punctuation">;</span>

    <span class="token keyword">const</span> newHook<span class="token operator">:</span> Hook <span class="token operator">=</span> <span class="token punctuation">{</span>
      memoizedState<span class="token operator">:</span> currentHook<span class="token punctuation">.</span>memoizedState<span class="token punctuation">,</span>

      baseState<span class="token operator">:</span> currentHook<span class="token punctuation">.</span>baseState<span class="token punctuation">,</span>
      queue<span class="token operator">:</span> currentHook<span class="token punctuation">.</span>queue<span class="token punctuation">,</span>
      baseUpdate<span class="token operator">:</span> currentHook<span class="token punctuation">.</span>baseUpdate<span class="token punctuation">,</span>

      next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>workInProgressHook <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      workInProgressHook <span class="token operator">=</span> firstWorkInProgressHook <span class="token operator">=</span> newHook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      workInProgressHook <span class="token operator">=</span> workInProgressHook<span class="token punctuation">.</span>next <span class="token operator">=</span> newHook<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    nextCurrentHook <span class="token operator">=</span> currentHook<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> workInProgressHook<span class="token punctuation">;</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/78c8bf48a9924705843f27bcfe146bdc" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">先看一看有没有workInProgressHook，如果有的话，直接使用，如果没有，从之前留着的hooks 链表里面拷贝需要的hook 出来，这样的结果就是每次re-render 完之后，都多了一个新版本的hooks 链表，我猜这里可能和fiber 涉及到的调解算法有关。</span></span></p></div></div></details></div></details><details id="https://www.notion.so/4fd93d5d260347ebb5fb4210d5f86351" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useEffect</code></span><span class="SemanticString"> 的实现？</span></span></summary><div class="Toggle__Content"><pre id="https://www.notion.so/157a9c80e47a4f44a5e4ec58f20b946d" class="Code"><code><span class="SemanticStringArray"><span class="SemanticString"><span><span class="token keyword">function</span> <span class="token function">commitHookEffectList</span><span class="token punctuation">(</span>
  unmountTag<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  mountTag<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  finishedWork<span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updateQueue<span class="token operator">:</span> FunctionComponentUpdateQueue <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>updateQuere<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> lastEffect <span class="token operator">=</span> updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">?</span> updateQueue<span class="token punctuation">.</span>lastEffect <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>lastEffect <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token keyword">let</span> effect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>tag <span class="token operator">&amp;</span> unmountTag<span class="token punctuation">)</span> <span class="token operator">!==</span> NoHookEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Unmount</span>
        <span class="token keyword">const</span> destory <span class="token operator">=</span> effect<span class="token punctuation">.</span>destroy<span class="token punctuation">;</span>
        effect<span class="token punctuation">.</span>destory <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>destory <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>tag <span class="token operator">&amp;</span> mountTag<span class="token punctuation">)</span> <span class="token operator">!==</span> NoHookEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	      <span class="token comment">// Mount</span>
        <span class="token keyword">const</span> create <span class="token operator">=</span> effect<span class="token punctuation">.</span>create<span class="token punctuation">;</span>
        effect<span class="token punctuation">.</span>destory <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
      effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token function">whlie</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></span></span></span></code></pre><div id="https://www.notion.so/8b6d4537853a464eb81c3e251b92cd00" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">这里可以发现，effect 的链表始终是循环链表，因为effect 一旦mount 了之后数量就是恒定的，永远不会受到其他事件的影响，所以每次从 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">lastEffect.next</code></span><span class="SemanticString"> 走起就好了。</span></span></p></div></div></details><details id="https://www.notion.so/5be7b3c92f494c4d95f3776e8875a658" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useState</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useEffect</code></span><span class="SemanticString"> 有何不同？</span></span></summary><div class="Toggle__Content"><ul class="BulletedListWrapper"><li id="https://www.notion.so/9cdbc0fab4b94798bf1341c236b1e230" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useState</code></span><span class="SemanticString"> 是在fiber 里面创建初始状态，然后返回一个callback 让用户来schedule 新一轮的re-render。</span></span></li><li id="https://www.notion.so/b9b0d50d4a0545c1a451f4691090db46" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">useEffect</code></span><span class="SemanticString"> 是在fiber 里面创建初始状态，然后在每次fiber commit 之后（render 完成之后），依次执行一些副作用操作。</span></span></li></ul><div id="https://www.notion.so/174bd34168ef4d2fb4a6a7200d551056" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7d16a0c5-e596-41a7-b913-d228b5dd19db%2FUntitled.png?width=1523&amp;table=block&amp;id=174bd341-68ef-4d2f-b4a6-a7200d551056"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F7d16a0c5-e596-41a7-b913-d228b5dd19db%2FUntitled.png?width=1523&amp;table=block&amp;id=174bd341-68ef-4d2f-b4a6-a7200d551056" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div><div id="https://www.notion.so/d39c20850269464e8a1566e12b78e436" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></div></details><details id="https://www.notion.so/6294db65f7274d19836fa5cd588365d3" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">update 的</span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">expirationTime</code></span><span class="SemanticString"> 是何时计算的？有何作用？</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/b062fee9c1ed4a90aa9de23c97ed7e84" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">是在创建update 的时候就决定的，用来帮助fiber 确定update 的优先级，fiber 因为其充分利用device 资源的特性，会根据当前的资源来决定是否进行当前的update，如果资源不足，则跳过，记录被跳过的第一个update 为 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">baseUpdate</code></span><span class="SemanticString"> 待之后又获得资源后从 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">baseUpdate</code></span><span class="SemanticString"> 重新更新。</span></span></p></div></div></details><div id="https://www.notion.so/b8cde68af34e487cb62b8cc2c5ebb1f1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><details id="https://www.notion.so/2d3f60a7b8464c408fb7c4dad9c58b13" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">talk about fiber</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/b6648ea81ff94e438e8ac18653c41ecb" class="Bookmark"><a href="https://juejin.im/post/5dadc6045188255a270a0f85"><h5 class="Bookmark__Title">这可能是最通俗的 React Fiber(时间分片) 打开方式</h5><p class="Bookmark__Desc">写一篇关于 React Fiber 的文章， 这个 Flag 立了很久，这也是今年的目标之一。 最近的在掘金的文章获得很多关注和鼓励，给了我很多动力，所以下定决心好好把它写出来。 我会以最通俗的方式将它讲透, 因此这算是一篇科普式的文章。不管你是使用React、还是Vue，这里面的思想值得学习学习! 一年一度的 React 春晚: React Conf 即将到来，不知道今年会不会有什么惊喜，去年是 React Hooks，前年是 React Fiber... 我得赶在 React Conf 之前发布这篇文章: 😲 React Fiber 已经出来这么久了， 这文章是老酒装新瓶吧? 对于我来说，通过这篇文章我重新认识了 React Fiber，它不是一个新东西, 它也是老酒装新瓶，不信你就看吧... 🆕 React Fiber 不是一个新的东西，但在前端领域是第一次广为认知的应用 。 😦 了解它有啥用? React Fiber 代码很复杂，门槛很高，你不了解它，后面 React 新出的 Killer Feature 你可能就更不能理解了 🤥 我不是升到React v16了吗?</p><p class="Bookmark__Link">https://juejin.im/post/5dadc6045188255a270a0f85</p></a></div><details id="https://www.notion.so/c7493f2b0eed436cb8b237616b666fb3" class="ColorfulBlock ColorfulBlock--ColorDefault Toggle "><summary class="Toggle__Summary"><span class="SemanticStringArray"><span class="SemanticString">啥是fiber</span></span></summary><div class="Toggle__Content"><div id="https://www.notion.so/28b4e177cd1245e0924f72f4a5f2c049" class="ColorfulBlock ColorfulBlock--BgGray Callout"><div class="Callout__Icon"><div class="Icon">💡</div></div><p class="Callout__Content"><span class="SemanticStringArray"><span class="SemanticString">React 中的fiber 协调算法的执行单元。</span></span></p></div><div id="https://www.notion.so/818ebf6a6db1454eb3fb5f38936c58e9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">解读一：fiber 相当于是react 中的协程。因为协程之间是主动协调任务的，所以其实react 无法对fiber 进行抢占式调度，全凭使用者的自觉，一般fiber 会主动检查是否超过了浏览器给的运行时间，如果超过就保存现场，把控制权还给浏览器（一般来说这个运行时间是16ms，1000ms / 60）。</span></span></p></div><div id="https://www.notion.so/a67c12ba486e4d8b9f9ef3ac96f3bf46" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">解读二：react 中的执行单元，每执行完一个fiber 就检查一下剩余时间。</span></span></p></div><div id="https://www.notion.so/96c86913b3d7403f8b59cb0f3bc16841" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/d40d10d1bcf943c4b265e8ba4c6a2e38" class="Image Image--PageWidth"><figure><a href="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3fc0f219-6bea-4400-a886-60e57ae173be%2FUntitled.png?width=960&amp;table=block&amp;id=d40d10d1-bcf9-43c4-b265-e8ba4c6a2e38"><img src="https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F3fc0f219-6bea-4400-a886-60e57ae173be%2FUntitled.png?width=960&amp;table=block&amp;id=d40d10d1-bcf9-43c4-b265-e8ba4c6a2e38" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></div></details><div id="https://www.notion.so/9f7ebea6ad8246ac8506e3ef9e1259cb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div></div></details></article>
  <footer class="Footer">
</footer>
</body>

</html>