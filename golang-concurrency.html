<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- iOS Safari -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Chrome, Firefox OS and Opera Status Bar Color -->
<meta name="theme-color" content="#FFFFFF">
<link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-webfont/1.6.0/style.css" />
<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">
<link rel="stylesheet" type="text/css"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.19.0/themes/prism.min.css">
<link rel="stylesheet" type="text/css" href="css/SourceSansPro.css">
<link rel="stylesheet" type="text/css" href="css/theme.css">
<link rel="stylesheet" type="text/css" href="css/notablog.css">
<!-- Favicon -->

  <link rel="shortcut icon" href="https://raw.githubusercontent.com/yujiachen-y/yjc567.github.io/main/pictures/icon.JPG">

<style>
  :root {
    font-size: 20px;
  }
</style>
  <title>Golang 并发相关笔记&nbsp;|&nbsp;AM0301</title>
  <meta property="og:type" content="blog">
  <meta property="og:title" content="Golang 并发相关笔记">
  
  
  <style>
    .DateTagBar {
      margin-top: 1.0rem;
    }
  </style>
</head>

<body>
  <nav class="Navbar">
  <a href="index.html">
    <div class="Navbar__Btn">
      
        <span><img class="inline-img-icon" src="https://raw.githubusercontent.com/yujiachen-y/yjc567.github.io/main/pictures/icon.JPG"></span>&nbsp;
      
      <span>Home</span>
    </div>
  </a>
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="about.html">
        <div class="Navbar__Btn">
          
          <span>关于</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="articles.html">
        <div class="Navbar__Btn">
          
          <span>文章</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="knowledge.html">
        <div class="Navbar__Btn">
          
          <span>摘抄</span>
        </div>
      </a>
    
  
    
      <span class="Navbar__Delim">&centerdot;</span>
      <a href="interests.html">
        <div class="Navbar__Btn">
          
          <span>兴趣</span>
        </div>
      </a>
    
  
    
  
    
  
    
  
    
  
    
  
</nav>
  <header class="Header">
    
    <div class="Header__Spacer Header__Spacer--NoCover">
    </div>
    
    <h1 class="Header__Title">Golang 并发相关笔记</h1>
    
      <div class="DateTagBar">
        
        
          <span class="DateTagBar__Item DateTagBar__Tag DateTagBar__Tag--blue">
            <a href="tag/摘抄.html">摘抄</a>
          </span>
        
      </div>
    
  </header>
  <article id="https://www.notion.so/ca5d12cab7174cc4b81a70bef8dc8774" class="PageRoot"><ul id="https://www.notion.so/3cab8740ab6b4af1ab476e295a1ebe71" class="ColorfulBlock ColorfulBlock--ColorGray TableOfContents"><li class="TableOfContents__Item"><a href="#https://www.notion.so/b96b2e0b45c7486e85e4136b4e365bf4"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">Goroutine和线程的区别</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/9aadaa7114754b088ff6de60b5ce9e93"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">GMP 模型</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/2cd05b04865949ee8ff9e0394f0ef172"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Global Queue &lt;&gt; Local Queue 交互</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/721c4d3c6206465197ac568ac4273f4e"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">P &lt;&gt; M 交互</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/0b0fe060863c456691ea4ca64af8109d"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">协程切换时机</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/c4289cd49a4a49b69f87f589e4e32b82"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">Context</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/57d62828ac884e9f9d9ee6ba1fd85bd4"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">同步原语</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/35ac56979ce346e3840d5cefcab47f29"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">sync.Mutex</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/f2c600bacd604a888825e05fd1b7fcf2"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">sync.RWMutex</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/36ecc41df60141a7b0a11beca64edd18"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">sync.Cond</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/abd3821cf41b4a18ad39cf49c48ce12f"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">sync/semaphore</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/7564f1562abb4ca18015cec8f4fa8126"><div style="margin-left:0px"><span class="SemanticStringArray"><span class="SemanticString">Timer</span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/c408c54b62e043359ccbd806608d6a59"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">调度器</strong></span></span></div></a></li><li class="TableOfContents__Item"><a href="#https://www.notion.so/58033d58328b4627a73f6859897cf139"><div style="margin-left:24px"><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">系统监控</strong></span></span></div></a></li></ul><h1 id="https://www.notion.so/b96b2e0b45c7486e85e4136b4e365bf4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/b96b2e0b45c7486e85e4136b4e365bf4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Goroutine和线程的区别</span></span></h1><ul class="BulletedListWrapper"><li id="https://www.notion.so/8643fb036e8b400ca9076eccbea3eeac" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">内存大小</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/a0cc8845959d44d7ab2d18b0c1c76c08" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">每个线程的内存大小是固定的，通常被指定为2MB，对一些轻量操作，这个内存大小过大；对一些重操作（比如疯狂递归），这个内存大小又会过小。</span></span></li><li id="https://www.notion.so/7114a967cfc54bd4a088dbb5c12a794f" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">goroutine的内存大小是动态变化的，通常的初始值为2KB。</span></span></li></ul></li><li id="https://www.notion.so/da4a2f6f6ca540ffa8d8f59dbfa4ca19" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调度</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/ab03d4bdbbad481ba4ada7a1217a5195" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">线程调度发生在内核态，由内核scheduler进行，线程切换会发生用户态到内核态的切换。</span></span></li><li id="https://www.notion.so/91047d8f8e2f45c38ed57a5dced7ffe6" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">goroutine的调度模型称为m:n，即m个协程，n个线程，线程的调度权当然还在内核，但是具体一个协程由哪个线程执行，完全由Go scheduler指定，发生在用户态，而且协程的优点是可以主动yield当前占用的线程给其他协程。</span></span></li></ul></li><li id="https://www.notion.so/d189df4a97034e3b911827f8d8b6de74" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">标识符</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/151ae5b113aa47c5a4b09ff36888730d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">每个线程在内核态都有一个线程标识符。</span></span></li><li id="https://www.notion.so/a98e8e554d684a7dab271539c94bfd4c" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">goroutine没有类似的标识符，阻止程序访问thread-local variable。</span></span></li></ul></li></ul><div id="https://www.notion.so/1e1161a39e00403ea6594cf4311380fb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/31753b645a604da69573428793e4af37" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">GOPMAXPROCS决定了一个Go程序可以使用多少个系统线程。</span></span></p></div><h1 id="https://www.notion.so/9aadaa7114754b088ff6de60b5ce9e93" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/9aadaa7114754b088ff6de60b5ce9e93"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">GMP 模型</span></span></h1><div id="https://www.notion.so/8b49eccd9cef44e8abc89e7cb2ba2d16" class="ColumnList"><div id="https://www.notion.so/3fcc092f707548898232e4427f9a2f2c" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><ul class="BulletedListWrapper"><li id="https://www.notion.so/ea7c890bfb964a8f95831d035f676cbe" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">G: Goroutine，一个协程。</span></span></li><li id="https://www.notion.so/c723e365df6444c3879f17b846e4c5eb" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">M: Machine，一个线程。</span></span></li><li id="https://www.notion.so/b8ce2fe7a89245208b1552cc799bdcfc" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">P: Processor，负责管理协程的数据结构。</span></span></li></ul></div><div id="https://www.notion.so/a8ca7c3150a9441896957e5791cd9479" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><div id="https://www.notion.so/7b0b7c5db4214b39ba7e9afa1a774ba6" class="Image Image--PageWidth"><figure><a href="https://img.draveness.me/2020-02-02-15805792666151-golang-gmp.png"><img src="https://img.draveness.me/2020-02-02-15805792666151-golang-gmp.png" style="width:100%"/></a><figcaption><span class="SemanticStringArray"></span></figcaption></figure></div></div></div><div id="https://www.notion.so/8e0259ad8de643cd9c4f34cd1336d260" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一个 P 绑定一个正在运行的线程 M，同时维护一个正在运行的协程 G，以及一个等待运行的协程队列 Local Queue。</span></span></p></div><div id="https://www.notion.so/5072b226add041609bed39ccb0525375" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Go 进程会维护一个全局唯一的协程队列 Global Queue，其中是不被特定 P 绑定的 Q。</span></span></p></div><h2 id="https://www.notion.so/2cd05b04865949ee8ff9e0394f0ef172" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/2cd05b04865949ee8ff9e0394f0ef172"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">Global Queue &lt;&gt; Local Queue 交互</strong></span></span></h2><div id="https://www.notion.so/a8be1d09f182413fb96f121e32281154" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">一个 G 创建出新的 G&#x27; 时，会先尝试把 G 放入对应 P 的 Local Queue 中，如果对应 Local Queue 满了，那么 G‘ 和 Local Queue 中的一半协程都会被放入 Global Queue 中。</span></span></p></div><div id="https://www.notion.so/5e6348c9301847ffbca89e03223f8451" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">P 每调度 n 次，就尝试会从 Global Queue 的队头获取一个 G&#x27; 执行。</span></span></p></div><div id="https://www.notion.so/d175057a28fa448aa34f7ca6a4013985" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">P 在一些时候也会从其他的 P&#x27; 上偷取 P&#x27; 中的 Local Queue 进行执行。</span></span></p></div><h2 id="https://www.notion.so/721c4d3c6206465197ac568ac4273f4e" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/721c4d3c6206465197ac568ac4273f4e"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">P &lt;&gt; M 交互</strong></span></span></h2><div id="https://www.notion.so/caf20da42e7c435bba9a67a80e7ea186" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">当一个线程 M 被系统阻塞时，P 会被绑定到一个新的 M 上。</span></span></p></div><h2 id="https://www.notion.so/0b0fe060863c456691ea4ca64af8109d" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/0b0fe060863c456691ea4ca64af8109d"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">协程切换时机</strong></span></span></h2><ul class="BulletedListWrapper"><li id="https://www.notion.so/07ba07e4944847ce9011e9d5ca72312a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">channel, 网络 IO, sync 包等阻塞操作。</span></span></li><li id="https://www.notion.so/71b62b81abee462488c1a6ffc6d78ee2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">runtime.GoShed 方法被调用。</span></span></li><li id="https://www.notion.so/45e8ecd55f6d4d058529038fbe87540e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">time 包，一个 P 会持有一个 timer 优先队列，堆顶是最早到期的协程。</span></span></li><li id="https://www.notion.so/82964c7ef64a491b882f3ae5a263d476" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">栈拷贝。</span></span></li><li id="https://www.notion.so/fae3eb7ef53347e886d99a9810cc1bdf" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">时间片耗尽，10 ms。</span></span></li></ul><h1 id="https://www.notion.so/c4289cd49a4a49b69f87f589e4e32b82" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/c4289cd49a4a49b69f87f589e4e32b82"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Context</span></span></h1><div id="https://www.notion.so/68792da930e24312ae3f0c5bc89581ca" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">context.Background</code></span><span class="SemanticString"> 和 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">context.TODO</code></span><span class="SemanticString"> 是两个指向 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">context.emptyCtx</code></span><span class="SemanticString"> 结构体的指针。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/437597fb55ca4034b4b5408f999353e4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">一般使用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">context.Background</code></span><span class="SemanticString"> 即可。</span></span></li><li id="https://www.notion.so/6b001123217b4b43b26941bc7c69e1e5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">如果被调用的函数需要传入 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">context.Context</code></span><span class="SemanticString">，但是当前还不确定如何构造这个 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">context</code></span><span class="SemanticString"> 对象，那么可以传入一个 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">context.TODO</code></span><span class="SemanticString">，未来再做替换。</span></span></li></ul><div id="https://www.notion.so/7d60cb19ae1d451da78f7d72e9a17538" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/3dd04d1f233c47c9bd5fcc52088742d9" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">context</code></span><span class="SemanticString"> 包中的各种函数可以衍生出各种 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">context</code></span><span class="SemanticString"> 对象，并对衍生出的对象注入相关信息，子对象会继承父对象带有的 value、取消机制等状态。</span></span></p></div><h1 id="https://www.notion.so/57d62828ac884e9f9d9ee6ba1fd85bd4" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/57d62828ac884e9f9d9ee6ba1fd85bd4"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">同步原语</span></span></h1><h2 id="https://www.notion.so/35ac56979ce346e3840d5cefcab47f29" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/35ac56979ce346e3840d5cefcab47f29"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">sync.Mutex</strong></span></span></h2><div id="https://www.notion.so/b0787ffb32e9457eb4d7dbceff767e57" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">有正常模式和饥饿模式，一旦有 Goroutine 超过 10ms 没能获取到锁，它就会将当前互斥锁切换到饥饿模式。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/7f770e00990748ef964466b800a6fe5e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">正常模式：谁活跃谁拿锁，不分获取锁请求的先后次序。</span></span></li><li id="https://www.notion.so/1ba32f2bc3244c8695510dde6c0fadf4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">饥饿模式：按队列顺序先进先出拿锁。</span></span></li></ul><h2 id="https://www.notion.so/f2c600bacd604a888825e05fd1b7fcf2" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/f2c600bacd604a888825e05fd1b7fcf2"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">sync.RWMutex</strong></span></span></h2><div id="https://www.notion.so/137ea83ba49d4f92955b74fb7261e4d3" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">知道读写锁被尝试获取写锁后，不会允许新的 Goroutines 获得读锁就好了。</span></span></p></div><h2 id="https://www.notion.so/36ecc41df60141a7b0a11beca64edd18" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/36ecc41df60141a7b0a11beca64edd18"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">sync.Cond</strong></span></span></h2><div id="https://www.notion.so/2be161e430784d9b9acce74e5a9ffbf1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不常用，但在 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">for checkCond { wait }</code></span><span class="SemanticString"> 的场景下，把 for 中的 wait 替换成 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sync.Cond</code></span><span class="SemanticString"> 可以避免自旋消耗 CPU，这也依赖其他控制 for 检查条件的 goroutines 在条件达成时会调用同一个 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sync.Cond</code></span><span class="SemanticString">。</span></span></p></div><div id="https://www.notion.so/8f9dbe0318dc4d60a720c7d0ae4b1abd" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">注意在创建一个 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sync.Cond</code></span><span class="SemanticString"> 的时候，还需要传入一个 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sync.Mutex</code></span><span class="SemanticString">，这个 mutex 的作用是用来保护临界区变量的，前面说到 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">sync.Cond</code></span><span class="SemanticString"> 是用来在 goroutines 之间同步条件，这里面的条件涉及到的变量就需要用到前面的 mutex 保护起来，不然会有竞争条件。</span></span></p></div><div id="https://www.notion.so/c325a4431ac949758fa130baef6f9736" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">下面通过调用流程来说明如何使用 mutex 和这个 mutex 变量初始化的 cond：</span></span></p></div><div id="https://www.notion.so/71fe4c496c374580bb568bc8d60ddf2a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/37fca1d9fae54590bf5f91390557e722" class="ColumnList"><div id="https://www.notion.so/ebcb2caefe134779a847a24a993ddacb" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><div id="https://www.notion.so/997eb8d8d26a4f50b503feb403a734a1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">条件修改方：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/d47031bf59834f2ca276a4a7050b141e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">cond.L.Lock() 等价于 mutex.Lock()</span></span></li><li id="https://www.notion.so/87837767a3d549ada23e024d16699e02" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">修改条件</span></span></li><li id="https://www.notion.so/13ab9981f25b4148923740d9c9d36d2e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">cond.Broadcast() / cond.Signal()</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/2e50ae8d83b8481e8ba866296d42aaf5" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">内部先释放锁 cond.L.Unlock()。</span></span></li><li id="https://www.notion.so/a19eb407ed6445758a0227a02f4698a4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">唤醒 `cond.notify` 链表中等待的 goroutine。</span></span></li><li id="https://www.notion.so/bbd89de05a004170afeeb53bcd6f52e2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">重新获取锁 cond.L.Lock()，返回上层调用。</span></span></li></ul></li><li id="https://www.notion.so/92ff19f0b649409ca852d7e0248571e7" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">(optional) 继续修改条件</span></span></li><li id="https://www.notion.so/4806a887c9a54b9497dfb96a199e5290" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">cond.L.Unlock() 等价于 mutex.Unlock()</span></span></li></ul></div><div id="https://www.notion.so/756a3723cbfa46d5a61d2708997067b7" class="Column" style="width:calc((100% - var(--column-spacing) * 1) * 0.5)"><div id="https://www.notion.so/e87f6e19e39b4cfc9002f05b6b5a4acb" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">条件检查方</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/912256091ea24beb88646f691bcc50e4" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">cond.L.Lock() 等价于 mutex.Lock()</span></span></li><li id="https://www.notion.so/12ec7e3efc3f46659ad21f9b82dfcf8b" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">for 检查条件</span></span></li><li id="https://www.notion.so/faed500b272d4b698c04b3eceea72401" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">cond.Wait()</span></span><ul class="BulletedListWrapper"><li id="https://www.notion.so/442d6e969d704229a1a5e1c5b9840be9" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">内部先释放锁 cond.L.Unlock()</span></span></li><li id="https://www.notion.so/e0c57eb39f2944a4a6c49aa3385669c1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">加入 `cond.notify` 链表，等待被唤醒</span></span></li><li id="https://www.notion.so/57268c1771c54b98a93468a543ccb672" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">重新获取锁 cond.L.Lock()，返回上层调用</span></span></li></ul></li><li id="https://www.notion.so/563f5013110c4357b925c5a930bd904d" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">cond.L.Unlock() 等价于 mutex.Unlock()</span></span></li></ul></div></div><div id="https://www.notion.so/ec76a84863b8476386f0bc696c2c0bc1" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><h2 id="https://www.notion.so/abd3821cf41b4a18ad39cf49c48ce12f" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/abd3821cf41b4a18ad39cf49c48ce12f"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">sync/semaphore</strong></span></span></h2><div id="https://www.notion.so/bc7aab76cb694f9994a12276ecc1cd96" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">不常用，知道信号量和锁的区别就是一个是数值，一个是 bool 就好了。</span></span></p></div><h1 id="https://www.notion.so/7564f1562abb4ca18015cec8f4fa8126" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--1"><a class="Anchor" href="#https://www.notion.so/7564f1562abb4ca18015cec8f4fa8126"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString">Timer</span></span></h1><div id="https://www.notion.so/03abdc7cca464d1d816637b4e935a1ff" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">GMP 模型中的每个 P 会维护一个计时器堆，堆是一个四叉堆，堆顶是最先到期的计时器。</span></span></p></div><div id="https://www.notion.so/112ed22088fd4875b106826d2d5ae692" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/b3dbfa6a369042c6b201cc6227840020" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">Go 会在两个模块触发计时器，检查计时器堆的堆顶，运行计时器中保存的函数：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/913f985f87a842e08f07d248a6e59d9e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调度器调度时会检查处理器 P 中的计时器是否准备就绪。</span></span></li><li id="https://www.notion.so/c443239cf45f493981dbfa9ad57a8a74" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">系统监控 runtime.sysmon 会检查是否有未执行的到期计时器。</span></span></li></ul><div id="https://www.notion.so/f95a357fc2f949f18d884c0760604084" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"></span></p></div><div id="https://www.notion.so/6dfbcf3494ff4f5bbe8a4e6bf69fda9f" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">标准库中的计时器已经可以胜任大部分工作，但是在 10ms 这个粒度下，社区中没有很好的计时器实现。</span></span></p></div><h2 id="https://www.notion.so/c408c54b62e043359ccbd806608d6a59" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/c408c54b62e043359ccbd806608d6a59"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">调度器</strong></span></span></h2><div id="https://www.notion.so/91cc10cc7dd849859f0b493abcb7d30a" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString">调度器指 Go 中用来调度管理 GMP 模型的程序。</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/e36f6a94d285452596393c0325ccd8e2" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调度器调用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">runtime.schedule</code></span><span class="SemanticString"> 执行调度。</span></span></li><li id="https://www.notion.so/ca249e6b6c1c42b28fe1f077894d738a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调度器调用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">runtime.findrunnable</code></span><span class="SemanticString"> 获取可执行的 Goroutine。</span></span></li><li id="https://www.notion.so/2703c756cb3e4a58aeed847838458dee" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">调度器调用 </span><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">runtime.findfunnable</code></span><span class="SemanticString"> 从其他处理器窃取计时器。</span></span></li></ul><h2 id="https://www.notion.so/58033d58328b4627a73f6859897cf139" class="ColorfulBlock ColorfulBlock--ColorDefault Heading Heading--2"><a class="Anchor" href="#https://www.notion.so/58033d58328b4627a73f6859897cf139"><svg width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><span class="SemanticStringArray"><span class="SemanticString"><strong class="SemanticString__Fragment SemanticString__Fragment--Bold">系统监控</strong></span></span></h2><div id="https://www.notion.so/7f913a99d4244b308f1131ce0f0c8a66" class="ColorfulBlock ColorfulBlock--ColorDefault Text"><p class="Text__Content"><span class="SemanticStringArray"><span class="SemanticString"><code class="SemanticString__Fragment SemanticString__Fragment--Code">runtime.sysmon</code></span><span class="SemanticString"> 是 Go runtime 的一个独立后台任务，有自己的独立线程，周期性地执行如下操作：</span></span></p></div><ul class="BulletedListWrapper"><li id="https://www.notion.so/f663e4a646474a2187cb92fe1ceb071e" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">抢占，防止有 goroutine 占据 CPU 过长时间。</span></span></li><li id="https://www.notion.so/db962b0d2fbc42b5ac710dd928fbe1a0" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">触发垃圾回收。</span></span></li><li id="https://www.notion.so/f1227ea941cb4590a1f547ca01ecd646" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">触发网络轮询。</span></span></li><li id="https://www.notion.so/12878afb6e0e4c22abcb63815538208a" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">检查 timer。</span></span></li><li id="https://www.notion.so/226c0c786451494c8489850a42c7c3a1" class="BulletedList"><span class="SemanticStringArray"><span class="SemanticString">检查死锁。</span></span></li></ul></article>
  <footer class="Footer">
</footer>
</body>

</html>